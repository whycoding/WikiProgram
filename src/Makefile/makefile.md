% GCC and Makefile Introduction

## GCC (GNU Compiler Collection)


### A Brief Introduction to GCC

GCC 1.0 was named the "GNU C Compiler" since it only handled the C programming language. It is now referred to as "GNU Compiler Collection" after being able to support other languages like c++. GCC also provides the implementation of the standard libraries for these languages (libstdc++,...). 


### GCC Compilation Process

The process of compilation includes pre-process, compile, link. 


### Headers (.h), Static Libraries (.lib, .a) and Shared Library (.dll, .so)

-I

-L

-l



## Make


### explicit expression

The explicit expression shows how to generate a target file based on the dependency files. 

```
target : dependency
    command
```

### implicit expression

Auto induction can be used in make. Then we can 

* The .o target can be generated by .c file
* The head files can be omitted by using -MMD option. 


When building C language projects, it is often necessary to rebuild a compilation unit when a header it includes is changed. make needs to be informed of these dependencies.

makedepend solves this problem by parsing the code of C source files to generate a list of dependencies


### Phony Targets (or Artificial Targets)
A target that does not represent a file is called a phony target. For example, the "clean" in the above example, which is just a label for a command. Phony target is always out-of-date and its command will be run. The standard phony targets are: all, clean, install.

### Variables

We can define variables inside makefile. 

The definition could be 

```
var1 = file1 file2 // file1 could be variable defined later
var1 := file1 file2 // file1 must be constant or variable defined before
var1 += file3 // adding another value to the variable
```


The variable can be used by $(var) or ${var}. 

Automatic variables are set by make after a rule is matched. There include:

* $@: the target filename.
* *: the target filename without the file extension.
* $<: the first prerequisite filename.
* $^: the filenames of all the prerequisites, separated by spaces, discard duplicates.
* $+: similar to $^, but includes duplicates.
* $?: the names of all prerequisites that are newer than the target, separated by spaces.


### Shell command

Shell command can be used in makefile. 

* Use @ before the shell command, then the command itself will out be displayed. For example, @echo compiling xxx. only compiling xxx will be displayed. 
* You have to use ; to make the previous command . For example, the first command is `cd xxx`. Without ;, the next command will still executed in the current directory. 
* You can use `-` before the command to omit the error message. For example, 'rm' returns . 
* You can also define a command package which is a group of commands. 

```
define CheckCompiler
  if [ $(GXX_VER_MAJOR) -lt $(REQ_MAJOR) ] || [ $(GXX_VER_MAJOR) -eq $(REQ_MAJOR)  -a $(GXX_VER_MINOR) -lt $(REQ_MINOR) ]; then \
    echo "** Your compiler is too old (`$(CXX) -dumpversion`)."; \
    echo "** You must use g++ $(REQ_MAJOR).$(REQ_MINOR).x or higher to compile the simulator."; \
    exit 2; \
  fi
endef
```


### function

Functions can be used by `$(function_name parameters, ...)`

* $(subst from, to, text) // substitute from to to in text

* $(patsubst pattern,replacement,text) 

* $(strip string) // remove the spaces at beginning and the end of the string

* $(dir names...) // get the directory

* $(if condition, then-part, else-part) 

* contents := $(shell cat foo)  return the result of the shell shell command

* $(filter %.o,$(files)) // obtain objects with .o in “$filter"

* $(wildcard *.o)



### control
ifeq、else 和 endif。ifeq 的意思表示条
件语句的开始，并指定一个条件表达式，表达式包含两个参数，以逗号分隔，

ifeq ($(strip $(foo)),) if return value is empty


### 文件指示。
其包括了三个部分，一个是在一个 Makefile 中引用另一个 Makefile，就像 C 语言中的include 一样；另一个是指根据某些情况指定 Makefile 中的有效部分，就像 C 语言中的预编译#if 一样；还有就是定义一个多行的命令。有关这一部分的内容，我会在后续的部分中讲述。 

include $(sources:.c=.d)
上述语句中的“$(sources:.c=.d)”中的“.c=.d”的意思是做一个替换，把变量
$(sources)所有[.c]的字串都替换成[.d]，关于这个“替换”的内容，在后面我会有更为详
细的讲述。当然，你得注意次序，因为 include 是按次来载入文件，最先载入的[.d]文件中
的目标会成为默认目标。
> $(sources:.c=.d) 中的“.c=.d”的意思是做一个替换，把变量 $(sources)所有[.c]的字串都替换成[.d]，
$(sources:%.c=%.d) 把变量 $(sources)所有[.c]的字串都替换成[.d]，

## Example
-g : produce debug info
-pipe : use pipes rather than temporary files for communicaitons between the various stages of compilation. faster
-Wall : all warning info
-Wextra : more warning info
-ffast-math : define the macro __FAST_MATH__ 
-std=c++11 : use the c++2011 version
-O3 : highest level of optimization for speed
-pg : program profiling


